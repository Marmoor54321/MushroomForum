@{
    ViewData["Title"] = "Miejsca grzybobrania";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }

        .leaflet-popup-content form {
            display: flex;
            flex-direction: column;
        }
    </style>
}

<h2>Miejsca grzybobrania</h2>
<div id="map"></div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([52.0, 19.0], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        function loadPins() {
            fetch('/MushroomSpots/GetAll')
                .then(res => res.json())
                .then(spots => {
                    spots.forEach(spot => {
                        const marker = L.marker([spot.latitude, spot.longitude]).addTo(map);
                        marker.bindPopup(`
            <div id="popup-${spot.id}">
                <b>${spot.name}</b><br>
                ${spot.description}<br><br>
        <form onsubmit="deleteSpot(event, ${spot.id})">
            <button type="submit" class="nav-link nav-button-green">Usuń</button>
        </form>
        <button type="button" class="nav-link nav-button-green"
                onclick="event.stopPropagation(); showEditForm(${spot.id}, '${spot.name}', '${spot.description.replace(/'/g, "\\'")}')">Edytuj
        </button>

            </div>
        `);
                    });
                });
        }
        function showEditForm(id, name, description) {
            const container = document.getElementById(`popup-${id}`);
            if (!container) return;

            const safeName = name.replace(/"/g, '&quot;');
            const safeDescription = description
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            container.innerHTML = `
            <form onsubmit="editSpot(event, ${id})" onclick="event.stopPropagation()">
                <input type="text" name="name" value="${safeName}" required /><br>
                <textarea name="description" onclick="event.stopPropagation()">${safeDescription}</textarea><br>
                        <button class="nav-link nav-button-green" type="submit" onclick="event.stopPropagation()">Zapisz</button>
            </form>
        `;
        }

        function editSpot(event, id) {
            event.preventDefault();
            const form = event.target;
            const name = form.name.value;
            const description = form.description.value;

            fetch('/MushroomSpots/Edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id, name, description })
            }).then(res => {
                if (res.ok) {
                    map.eachLayer(layer => {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });
                    loadPins();
                } else {
                    alert("Nie udało się zaktualizować pinezki.");
                }
            });
        }


        function deleteSpot(event, id) {
            event.preventDefault();
            if (confirm("Czy na pewno chcesz usunąć to miejsce?")) {
                fetch('/MushroomSpots/Delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(id)
                }).then(res => {
                    if (res.ok) {
                        map.eachLayer(layer => {
                            if (layer instanceof L.Marker) {
                                map.removeLayer(layer);
                            }
                        });
                        loadPins();
                    } else {
                        alert("Nie udało się usunąć pinezki.");
                    }
                });
            }
        }


        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            const popup = L.popup()
                .setLatLng(e.latlng)
                .setContent(`
                            <form method="post" action="/MushroomSpots/Create">
                                <input name="Name" placeholder="Nazwa" required />
                                <textarea name="Description" placeholder="Opis"></textarea>
                                <input type="hidden" name="Latitude" value="${lat}" />
                                <input type="hidden" name="Longitude" value="${lng}" />
                                <button type="submit">Dodaj</button>
                            </form>`)
                .openOn(map);
        });

        loadPins();
    </script>
}
